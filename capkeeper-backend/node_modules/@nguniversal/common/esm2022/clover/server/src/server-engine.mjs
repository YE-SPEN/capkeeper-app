/**
 * @license
 * Copyright Google LLC All Rights Reserved.
 *
 * Use of this source code is governed by an MIT-style license that can be
 * found in the LICENSE file at https://angular.io/license
 */
import * as fs from 'fs';
import { CookieJar, JSDOM } from 'jsdom';
import * as path from 'path';
import { URL } from 'url';
import { CustomResourceLoader } from './custom-resource-loader';
import { InlineCriticalCssProcessor } from './inline-css-processor';
import { augmentWindowWithStubs } from './stubs';
/**
 * @deprecated This experimental API will be removed in version 16.
 * @experimental
 */
export class Engine {
    constructor() {
        this.fileExistsCache = new Map();
        this.htmlFileCache = new Map();
        this.resourceLoaderCache = new Map();
        this.inlineCriticalCssProcessor = new InlineCriticalCssProcessor({ minify: true }, this.resourceLoaderCache);
    }
    async render(options) {
        const { pathname, origin } = new URL(options.url);
        const prerenderedSnapshot = await this.getPrerenderedSnapshot(options.publicPath, pathname);
        if (prerenderedSnapshot) {
            return prerenderedSnapshot;
        }
        let htmlContent = await this.getHtmlTemplate(options.publicPath, pathname, options.htmlFilename);
        const inlineCriticalCss = options.inlineCriticalCss !== false;
        const customResourceLoader = new CustomResourceLoader(options.headers, options.publicPath, origin, this.resourceLoaderCache);
        let dom;
        if (inlineCriticalCss) {
            // Workaround for https://github.com/GoogleChromeLabs/critters/issues/64
            htmlContent = htmlContent.replace(/ media="print" onload="this\.media=['&apos;].+?['&apos;]"(?: ngCspMedia=".+")?><noscript><link .+?><\/noscript>/g, '>');
        }
        // JSDOM doesn't support type=module
        // https://github.com/jsdom/jsdom/issues/2475
        htmlContent = htmlContent.replace(/ type="module"/g, '');
        try {
            dom = new JSDOM(htmlContent, {
                runScripts: 'dangerously',
                resources: customResourceLoader,
                url: options.url,
                referrer: options.headers?.referrer,
                cookieJar: new CookieJar(undefined, {
                    allowSpecialUseDomain: true,
                }),
                beforeParse: (window) => {
                    augmentWindowWithStubs(window);
                    window.ngRenderMode = true;
                },
            });
            const doc = dom.window.document;
            // 60s timeout.
            const stablizationTimeout = setTimeout(() => {
                throw new Error('Angular application failed to stablize after in time.');
            }, 60000);
            const ngRenderMode = await new Promise((resolve) => {
                const interval = setInterval(() => {
                    const ngDOMMode = dom?.window.ngRenderMode;
                    if (ngDOMMode && typeof ngDOMMode === 'object') {
                        // Poll until ngDOMMode is an object.
                        clearTimeout(stablizationTimeout);
                        clearInterval(interval);
                        resolve(ngDOMMode);
                    }
                }, 30);
            });
            await ngRenderMode.getWhenStable();
            doc.querySelector('[ng-version]')?.setAttribute('ng-clover', '');
            // Add Angular state
            const state = ngRenderMode.getSerializedState();
            if (state) {
                const script = doc.createElement('script');
                script.id = `${ngRenderMode.appId}-state`;
                script.setAttribute('type', 'application/json');
                script.textContent = state;
                doc.body.appendChild(script);
            }
            const content = dom.serialize();
            if (!inlineCriticalCss) {
                return content;
            }
            const baseHref = doc.querySelector('base[href]')?.getAttribute('href') ?? '';
            const { content: contentWithInlineCSS, warnings, errors, } = await this.inlineCriticalCssProcessor.process(content, {
                outputPath: path.join(options.publicPath, baseHref),
            });
            // eslint-disable-next-line no-console
            warnings?.forEach((m) => console.warn(m));
            // eslint-disable-next-line no-console
            errors?.forEach((m) => console.error(m));
            return contentWithInlineCSS;
        }
        finally {
            dom?.window.close();
        }
    }
    async getPrerenderedSnapshot(publicPath, pathname) {
        // Remove leading forward slash.
        const pagePath = path.resolve(publicPath, pathname.substring(1), 'index.html');
        const content = await this.readHTMLFile(pagePath);
        return content?.includes('ng-version=')
            ? content // Page is pre-rendered
            : undefined;
    }
    async getHtmlTemplate(publicPath, pathname, htmlFilename = 'index.html') {
        const files = [path.join(publicPath, htmlFilename)];
        const potentialLocalePath = pathname.split('/', 2)[1]; // potential base href
        if (potentialLocalePath) {
            files.push(path.join(publicPath, potentialLocalePath, htmlFilename));
        }
        for (const file of files) {
            const content = await this.readHTMLFile(file);
            if (content) {
                return content;
            }
        }
        throw new Error(`Cannot file HTML file. Looked in: ${files.join(', ')}`);
    }
    async fileExists(filePath) {
        const fileExists = this.fileExistsCache.get(filePath);
        if (fileExists === undefined) {
            try {
                await fs.promises.access(filePath, fs.constants.F_OK);
                this.fileExistsCache.set(filePath, true);
                return true;
            }
            catch {
                this.fileExistsCache.set(filePath, false);
                return false;
            }
        }
        return fileExists;
    }
    async readHTMLFile(filePath) {
        if (this.htmlFileCache.has(filePath)) {
            return this.htmlFileCache.get(filePath);
        }
        if (await this.fileExists(filePath)) {
            const content = await fs.promises.readFile(filePath, 'utf-8');
            this.htmlFileCache.set(filePath, content);
            return content;
        }
        return undefined;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic2VydmVyLWVuZ2luZS5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uLy4uLy4uLy4uLy4uL21vZHVsZXMvY29tbW9uL2Nsb3Zlci9zZXJ2ZXIvc3JjL3NlcnZlci1lbmdpbmUudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IkFBQUE7Ozs7OztHQU1HO0FBTUgsT0FBTyxLQUFLLEVBQUUsTUFBTSxJQUFJLENBQUM7QUFDekIsT0FBTyxFQUFFLFNBQVMsRUFBRSxLQUFLLEVBQUUsTUFBTSxPQUFPLENBQUM7QUFDekMsT0FBTyxLQUFLLElBQUksTUFBTSxNQUFNLENBQUM7QUFDN0IsT0FBTyxFQUFFLEdBQUcsRUFBRSxNQUFNLEtBQUssQ0FBQztBQUMxQixPQUFPLEVBQUUsb0JBQW9CLEVBQUUsTUFBTSwwQkFBMEIsQ0FBQztBQUNoRSxPQUFPLEVBQUUsMEJBQTBCLEVBQUUsTUFBTSx3QkFBd0IsQ0FBQztBQUNwRSxPQUFPLEVBQUUsc0JBQXNCLEVBQUUsTUFBTSxTQUFTLENBQUM7QUFjakQ7OztHQUdHO0FBRUgsTUFBTSxPQUFPLE1BQU07SUFBbkI7UUFDbUIsb0JBQWUsR0FBRyxJQUFJLEdBQUcsRUFBbUIsQ0FBQztRQUM3QyxrQkFBYSxHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQzFDLHdCQUFtQixHQUFHLElBQUksR0FBRyxFQUFrQixDQUFDO1FBQ2hELCtCQUEwQixHQUFHLElBQUksMEJBQTBCLENBQzFFLEVBQUUsTUFBTSxFQUFFLElBQUksRUFBRSxFQUNoQixJQUFJLENBQUMsbUJBQW1CLENBQ3pCLENBQUM7SUFpTEosQ0FBQztJQS9LQyxLQUFLLENBQUMsTUFBTSxDQUFDLE9BQXNCO1FBQ2pDLE1BQU0sRUFBRSxRQUFRLEVBQUUsTUFBTSxFQUFFLEdBQUcsSUFBSSxHQUFHLENBQUMsT0FBTyxDQUFDLEdBQUcsQ0FBQyxDQUFDO1FBQ2xELE1BQU0sbUJBQW1CLEdBQUcsTUFBTSxJQUFJLENBQUMsc0JBQXNCLENBQUMs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QUFnQjtRQUN2QyxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsQ0FBQztRQUN0RCxJQUFJLFVBQVUsS0FBSyxTQUFTLEVBQUU7WUFDNUIsSUFBSTtnQkFDRixNQUFNLEVBQUUsQ0FBQyxRQUFRLENBQUMsTUFBTSxDQUFDLFFBQVEsRUFBRSxFQUFFLENBQUMsU0FBUyxDQUFDLElBQUksQ0FBQyxDQUFDO2dCQUN0RCxJQUFJLENBQUMsZUFBZSxDQUFDLEdBQUcsQ0FBQyxRQUFRLEVBQUUsSUFBSSxDQUFDLENBQUM7Z0JBRXpDLE9BQU8sSUFBSSxDQUFDO2FBQ2I7WUFBQyxNQUFNO2dCQUNOLElBQUksQ0FBQyxlQUFlLENBQUMsR0FBRyxDQUFDLFFBQVEsRUFBRSxLQUFLLENBQUMsQ0FBQztnQkFFMUMsT0FBTyxLQUFLLENBQUM7YUFDZDtTQUNGO1FBRUQsT0FBTyxVQUFVLENBQUM7SUFDcEIsQ0FBQztJQUVPLEtBQUssQ0FBQyxZQUFZLENBQUMsUUFBZ0I7UUFDekMsSUFBSSxJQUFJLENBQUMsYUFBYSxDQUFDLEdBQUcsQ0FBQyxRQUFRLENBQUMsRUFBRTtZQUNwQyxPQUFPLElBQUksQ0FBQyxhQUFhLENBQUMsR0FBRyxDQUFDLFFBQVEsQ0FBQyxDQUFDO1NBQ3pDO1FBRUQsSUFBSSxNQUFNLElBQUksQ0FBQyxVQUFVLENBQUMsUUFBUSxDQUFDLEVBQUU7WUFDbkMsTUFBTSxPQUFPLEdBQUcsTUFBTSxFQUFFLENBQUMsUUFBUSxDQUFDLFFBQVEsQ0FBQyxRQUFRLEVBQUUsT0FBTyxDQUFDLENBQUM7WUFDOUQsSUFBSSxDQUFDLGFBQWEsQ0FBQyxHQUFHLENBQUMsUUFBUSxFQUFFLE9BQU8sQ0FBQyxDQUFDO1lBRTFDLE9BQU8sT0FBTyxDQUFDO1NBQ2hCO1FBRUQsT0FBTyxTQUFTLENBQUM7SUFDbkIsQ0FBQztDQUNGIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBAbGljZW5zZVxuICogQ29weXJpZ2h0IEdvb2dsZSBMTEMgQWxsIFJpZ2h0cyBSZXNlcnZlZC5cbiAqXG4gKiBVc2Ugb2YgdGhpcyBzb3VyY2UgY29kZSBpcyBnb3Zlcm5lZCBieSBhbiBNSVQtc3R5bGUgbGljZW5zZSB0aGF0IGNhbiBiZVxuICogZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCBodHRwczovL2FuZ3VsYXIuaW8vbGljZW5zZVxuICovXG5cbmltcG9ydCB7XG4gIMm1TkdSZW5kZXJNb2RlIGFzIE5HUmVuZGVyTW9kZSxcbiAgybVOR1JlbmRlck1vZGVBUEkgYXMgTkdSZW5kZXJNb2RlQVBJLFxufSBmcm9tICdAbmd1bml2ZXJzYWwvY29tbW9uL2Nsb3Zlcic7XG5pbXBvcnQgKiBhcyBmcyBmcm9tICdmcyc7XG5pbXBvcnQgeyBDb29raWVKYXIsIEpTRE9NIH0gZnJvbSAnanNkb20nO1xuaW1wb3J0ICogYXMgcGF0aCBmcm9tICdwYXRoJztcbmltcG9ydCB7IFVSTCB9IGZyb20gJ3VybCc7XG5pbXBvcnQgeyBDdXN0b21SZXNvdXJjZUxvYWRlciB9IGZyb20gJy4vY3VzdG9tLXJlc291cmNlLWxvYWRlcic7XG5pbXBvcnQgeyBJbmxpbmVDcml0aWNhbENzc1Byb2Nlc3NvciB9IGZyb20gJy4vaW5saW5lLWNzcy1wcm9jZXNzb3InO1xuaW1wb3J0IHsgYXVnbWVudFdpbmRvd1dpdGhTdHVicyB9IGZyb20gJy4vc3R1YnMnO1xuXG4vKipcbiAqIEBkZXByZWNhdGVkIFRoaXMgZXhwZXJpbWVudGFsIEFQSSB3aWxsIGJlIHJlbW92ZWQgaW4gdmVyc2lvbiAxNi5cbiAqIEBleHBlcmltZW50YWxcbiAqL1xuXG5leHBvcnQgaW50ZXJmYWNlIFJlbmRlck9wdGlvbnMge1xuICBoZWFkZXJzPzogUmVjb3JkPHN0cmluZywgc3RyaW5nIHwgdW5kZWZpbmVkIHwgc3RyaW5nW10+O1xuICB1cmw6IHN0cmluZztcbiAgaW5saW5lQ3JpdGljYWxDc3M/OiBib29sZWFuO1xuICBodG1sRmlsZW5hbWU/OiBzdHJpbmc7XG4gIHB1YmxpY1BhdGg6IHN0cmluZztcbn1cbi8qKlxuICogQGRlcHJlY2F0ZWQgVGhpcyBleHBlcmltZW50YWwgQVBJIHdpbGwgYmUgcmVtb3ZlZCBpbiB2ZXJzaW9uIDE2LlxuICogQGV4cGVyaW1lbnRhbFxuICovXG5cbmV4cG9ydCBjbGFzcyBFbmdpbmUge1xuICBwcml2YXRlIHJlYWRvbmx5IGZpbGVFeGlzdHNDYWNoZSA9IG5ldyBNYXA8c3RyaW5nLCBib29sZWFuPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGh0bWxGaWxlQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgc3RyaW5nPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IHJlc291cmNlTG9hZGVyQ2FjaGUgPSBuZXcgTWFwPHN0cmluZywgQnVmZmVyPigpO1xuICBwcml2YXRlIHJlYWRvbmx5IGlubGluZUNyaXRpY2FsQ3NzUHJvY2Vzc29yID0gbmV3IElubGluZUNyaXRpY2FsQ3NzUHJvY2Vzc29yKFxuICAgIHsgbWluaWZ5OiB0cnVlIH0sXG4gICAgdGhpcy5yZXNvdXJjZUxvYWRlckNhY2hlLFxuICApO1xuXG4gIGFzeW5jIHJlbmRlcihvcHRpb25zOiBSZW5kZXJPcHRpb25zKTogUHJvbWlzZTxzdHJpbmc+IHtcbiAgICBjb25zdCB7IHBhdGhuYW1lLCBvcmlnaW4gfSA9IG5ldyBVUkwob3B0aW9ucy51cmwpO1xuICAgIGNvbnN0IHByZXJlbmRlcmVkU25hcHNob3QgPSBhd2FpdCB0aGlzLmdldFByZXJlbmRlcmVkU25hcHNob3Qob3B0aW9ucy5wdWJsaWNQYXRoLCBwYXRobmFtZSk7XG5cbiAgICBpZiAocHJlcmVuZGVyZWRTbmFwc2hvdCkge1xuICAgICAgcmV0dXJuIHByZXJlbmRlcmVkU25hcHNob3Q7XG4gICAgfVxuXG4gICAgbGV0IGh0bWxDb250ZW50ID0gYXdhaXQgdGhpcy5nZXRIdG1sVGVtcGxhdGUoXG4gICAgICBvcHRpb25zLnB1YmxpY1BhdGgsXG4gICAgICBwYXRobmFtZSxcbiAgICAgIG9wdGlvbnMuaHRtbEZpbGVuYW1lLFxuICAgICk7XG4gICAgY29uc3QgaW5saW5lQ3JpdGljYWxDc3MgPSBvcHRpb25zLmlubGluZUNyaXRpY2FsQ3NzICE9PSBmYWxzZTtcblxuICAgIGNvbnN0IGN1c3RvbVJlc291cmNlTG9hZGVyID0gbmV3IEN1c3RvbVJlc291cmNlTG9hZGVyKFxuICAgICAgb3B0aW9ucy5oZWFkZXJzLFxuICAgICAgb3B0aW9ucy5wdWJsaWNQYXRoLFxuICAgICAgb3JpZ2luLFxuICAgICAgdGhpcy5yZXNvdXJjZUxvYWRlckNhY2hlLFxuICAgICk7XG5cbiAgICBsZXQgZG9tOiBKU0RPTSB8IHVuZGVmaW5lZDtcblxuICAgIGlmIChpbmxpbmVDcml0aWNhbENzcykge1xuICAgICAgLy8gV29ya2Fyb3VuZCBmb3IgaHR0cHM6Ly9naXRodWIuY29tL0dvb2dsZUNocm9tZUxhYnMvY3JpdHRlcnMvaXNzdWVzLzY0XG4gICAgICBodG1sQ29udGVudCA9IGh0bWxDb250ZW50LnJlcGxhY2UoXG4gICAgICAgIC8gbWVkaWE9XCJwcmludFwiIG9ubG9hZD1cInRoaXNcXC5tZWRpYT1bJyZhcG9zO10uKz9bJyZhcG9zO11cIig/OiBuZ0NzcE1lZGlhPVwiLitcIik/Pjxub3NjcmlwdD48bGluayAuKz8+PFxcL25vc2NyaXB0Pi9nLFxuICAgICAgICAnPicsXG4gICAgICApO1xuICAgIH1cblxuICAgIC8vIEpTRE9NIGRvZXNuJ3Qgc3VwcG9ydCB0eXBlPW1vZHVsZVxuICAgIC8vIGh0dHBzOi8vZ2l0aHViLmNvbS9qc2RvbS9qc2RvbS9pc3N1ZXMvMjQ3NVxuICAgIGh0bWxDb250ZW50ID0gaHRtbENvbnRlbnQucmVwbGFjZSgvIHR5cGU9XCJtb2R1bGVcIi9nLCAnJyk7XG5cbiAgICB0cnkge1xuICAgICAgZG9tID0gbmV3IEpTRE9NKGh0bWxDb250ZW50LCB7XG4gICAgICAgIHJ1blNjcmlwdHM6ICdkYW5nZXJvdXNseScsXG4gICAgICAgIHJlc291cmNlczogY3VzdG9tUmVzb3VyY2VMb2FkZXIsXG4gICAgICAgIHVybDogb3B0aW9ucy51cmwsXG4gICAgICAgIHJlZmVycmVyOiBvcHRpb25zLmhlYWRlcnM/LnJlZmVycmVyIGFzIHN0cmluZyB8IHVuZGVmaW5lZCxcbiAgICAgICAgY29va2llSmFyOiBuZXcgQ29va2llSmFyKHVuZGVmaW5lZCwge1xuICAgICAgICAgIGFsbG93U3BlY2lhbFVzZURvbWFpbjogdHJ1ZSxcbiAgICAgICAgfSksXG4gICAgICAgIGJlZm9yZVBhcnNlOiAod2luZG93KSA9PiB7XG4gICAgICAgICAgYXVnbWVudFdpbmRvd1dpdGhTdHVicyh3aW5kb3cpO1xuICAgICAgICAgIHdpbmRvdy5uZ1JlbmRlck1vZGUgPSB0cnVlO1xuICAgICAgICB9LFxuICAgICAgfSk7XG5cbiAgICAgIGNvbnN0IGRvYyA9IGRvbS53aW5kb3cuZG9jdW1lbnQ7XG5cbiAgICAgIC8vIDYwcyB0aW1lb3V0LlxuICAgICAgY29uc3Qgc3RhYmxpemF0aW9uVGltZW91dCA9IHNldFRpbWVvdXQoKCkgPT4ge1xuICAgICAgICB0aHJvdyBuZXcgRXJyb3IoJ0FuZ3VsYXIgYXBwbGljYXRpb24gZmFpbGVkIHRvIHN0YWJsaXplIGFmdGVyIGluIHRpbWUuJyk7XG4gICAgICB9LCA2MDAwMCk7XG5cbiAgICAgIGNvbnN0IG5nUmVuZGVyTW9kZSA9IGF3YWl0IG5ldyBQcm9taXNlPE5HUmVuZGVyTW9kZUFQST4oKHJlc29sdmUpID0+IHtcbiAgICAgICAgY29uc3QgaW50ZXJ2YWwgPSBzZXRJbnRlcnZhbCgoKSA9PiB7XG4gICAgICAgICAgY29uc3QgbmdET01Nb2RlID0gZG9tPy53aW5kb3cubmdSZW5kZXJNb2RlIGFzIE5HUmVuZGVyTW9kZTtcbiAgICAgICAgICBpZiAobmdET01Nb2RlICYmIHR5cGVvZiBuZ0RPTU1vZGUgPT09ICdvYmplY3QnKSB7XG4gICAgICAgICAgICAvLyBQb2xsIHVudGlsIG5nRE9NTW9kZSBpcyBhbiBvYmplY3QuXG4gICAgICAgICAgICBjbGVhclRpbWVvdXQoc3RhYmxpemF0aW9uVGltZW91dCk7XG4gICAgICAgICAgICBjbGVhckludGVydmFsKGludGVydmFsKTtcbiAgICAgICAgICAgIHJlc29sdmUobmdET01Nb2RlKTtcbiAgICAgICAgICB9XG4gICAgICAgIH0sIDMwKTtcbiAgICAgIH0pO1xuXG4gICAgICBhd2FpdCBuZ1JlbmRlck1vZGUuZ2V0V2hlblN0YWJsZSgpO1xuICAgICAgZG9jLnF1ZXJ5U2VsZWN0b3IoJ1tuZy12ZXJzaW9uXScpPy5zZXRBdHRyaWJ1dGUoJ25nLWNsb3ZlcicsICcnKTtcblxuICAgICAgLy8gQWRkIEFuZ3VsYXIgc3RhdGVcbiAgICAgIGNvbnN0IHN0YXRlID0gbmdSZW5kZXJNb2RlLmdldFNlcmlhbGl6ZWRTdGF0ZSgpO1xuICAgICAgaWYgKHN0YXRlKSB7XG4gICAgICAgIGNvbnN0IHNjcmlwdCA9IGRvYy5jcmVhdGVFbGVtZW50KCdzY3JpcHQnKTtcbiAgICAgICAgc2NyaXB0LmlkID0gYCR7bmdSZW5kZXJNb2RlLmFwcElkfS1zdGF0ZWA7XG4gICAgICAgIHNjcmlwdC5zZXRBdHRyaWJ1dGUoJ3R5cGUnLCAnYXBwbGljYXRpb24vanNvbicpO1xuICAgICAgICBzY3JpcHQudGV4dENvbnRlbnQgPSBzdGF0ZTtcbiAgICAgICAgZG9jLmJvZHkuYXBwZW5kQ2hpbGQoc2NyaXB0KTtcbiAgICAgIH1cblxuICAgICAgY29uc3QgY29udGVudCA9IGRvbS5zZXJpYWxpemUoKTtcbiAgICAgIGlmICghaW5saW5lQ3JpdGljYWxDc3MpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgICB9XG5cbiAgICAgIGNvbnN0IGJhc2VIcmVmID0gZG9jLnF1ZXJ5U2VsZWN0b3IoJ2Jhc2VbaHJlZl0nKT8uZ2V0QXR0cmlidXRlKCdocmVmJykgPz8gJyc7XG4gICAgICBjb25zdCB7XG4gICAgICAgIGNvbnRlbnQ6IGNvbnRlbnRXaXRoSW5saW5lQ1NTLFxuICAgICAgICB3YXJuaW5ncyxcbiAgICAgICAgZXJyb3JzLFxuICAgICAgfSA9IGF3YWl0IHRoaXMuaW5saW5lQ3JpdGljYWxDc3NQcm9jZXNzb3IucHJvY2Vzcyhjb250ZW50LCB7XG4gICAgICAgIG91dHB1dFBhdGg6IHBhdGguam9pbihvcHRpb25zLnB1YmxpY1BhdGgsIGJhc2VIcmVmKSxcbiAgICAgIH0pO1xuXG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgd2FybmluZ3M/LmZvckVhY2goKG0pID0+IGNvbnNvbGUud2FybihtKSk7XG4gICAgICAvLyBlc2xpbnQtZGlzYWJsZS1uZXh0LWxpbmUgbm8tY29uc29sZVxuICAgICAgZXJyb3JzPy5mb3JFYWNoKChtKSA9PiBjb25zb2xlLmVycm9yKG0pKTtcblxuICAgICAgcmV0dXJuIGNvbnRlbnRXaXRoSW5saW5lQ1NTO1xuICAgIH0gZmluYWxseSB7XG4gICAgICBkb20/LndpbmRvdy5jbG9zZSgpO1xuICAgIH1cbiAgfVxuXG4gIHByaXZhdGUgYXN5bmMgZ2V0UHJlcmVuZGVyZWRTbmFwc2hvdChcbiAgICBwdWJsaWNQYXRoOiBzdHJpbmcsXG4gICAgcGF0aG5hbWU6IHN0cmluZyxcbiAgKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgICAvLyBSZW1vdmUgbGVhZGluZyBmb3J3YXJkIHNsYXNoLlxuICAgIGNvbnN0IHBhZ2VQYXRoID0gcGF0aC5yZXNvbHZlKHB1YmxpY1BhdGgsIHBhdGhuYW1lLnN1YnN0cmluZygxKSwgJ2luZGV4Lmh0bWwnKTtcbiAgICBjb25zdCBjb250ZW50ID0gYXdhaXQgdGhpcy5yZWFkSFRNTEZpbGUocGFnZVBhdGgpO1xuXG4gICAgcmV0dXJuIGNvbnRlbnQ/LmluY2x1ZGVzKCduZy12ZXJzaW9uPScpXG4gICAgICA/IGNvbnRlbnQgLy8gUGFnZSBpcyBwcmUtcmVuZGVyZWRcbiAgICAgIDogdW5kZWZpbmVkO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBnZXRIdG1sVGVtcGxhdGUoXG4gICAgcHVibGljUGF0aDogc3RyaW5nLFxuICAgIHBhdGhuYW1lOiBzdHJpbmcsXG4gICAgaHRtbEZpbGVuYW1lID0gJ2luZGV4Lmh0bWwnLFxuICApOiBQcm9taXNlPHN0cmluZz4ge1xuICAgIGNvbnN0IGZpbGVzID0gW3BhdGguam9pbihwdWJsaWNQYXRoLCBodG1sRmlsZW5hbWUpXTtcblxuICAgIGNvbnN0IHBvdGVudGlhbExvY2FsZVBhdGggPSBwYXRobmFtZS5zcGxpdCgnLycsIDIpWzFdOyAvLyBwb3RlbnRpYWwgYmFzZSBocmVmXG4gICAgaWYgKHBvdGVudGlhbExvY2FsZVBhdGgpIHtcbiAgICAgIGZpbGVzLnB1c2gocGF0aC5qb2luKHB1YmxpY1BhdGgsIHBvdGVudGlhbExvY2FsZVBhdGgsIGh0bWxGaWxlbmFtZSkpO1xuICAgIH1cblxuICAgIGZvciAoY29uc3QgZmlsZSBvZiBmaWxlcykge1xuICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IHRoaXMucmVhZEhUTUxGaWxlKGZpbGUpO1xuICAgICAgaWYgKGNvbnRlbnQpIHtcbiAgICAgICAgcmV0dXJuIGNvbnRlbnQ7XG4gICAgICB9XG4gICAgfVxuXG4gICAgdGhyb3cgbmV3IEVycm9yKGBDYW5ub3QgZmlsZSBIVE1MIGZpbGUuIExvb2tlZCBpbjogJHtmaWxlcy5qb2luKCcsICcpfWApO1xuICB9XG5cbiAgcHJpdmF0ZSBhc3luYyBmaWxlRXhpc3RzKGZpbGVQYXRoOiBzdHJpbmcpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zdCBmaWxlRXhpc3RzID0gdGhpcy5maWxlRXhpc3RzQ2FjaGUuZ2V0KGZpbGVQYXRoKTtcbiAgICBpZiAoZmlsZUV4aXN0cyA9PT0gdW5kZWZpbmVkKSB7XG4gICAgICB0cnkge1xuICAgICAgICBhd2FpdCBmcy5wcm9taXNlcy5hY2Nlc3MoZmlsZVBhdGgsIGZzLmNvbnN0YW50cy5GX09LKTtcbiAgICAgICAgdGhpcy5maWxlRXhpc3RzQ2FjaGUuc2V0KGZpbGVQYXRoLCB0cnVlKTtcblxuICAgICAgICByZXR1cm4gdHJ1ZTtcbiAgICAgIH0gY2F0Y2gge1xuICAgICAgICB0aGlzLmZpbGVFeGlzdHNDYWNoZS5zZXQoZmlsZVBhdGgsIGZhbHNlKTtcblxuICAgICAgICByZXR1cm4gZmFsc2U7XG4gICAgICB9XG4gICAgfVxuXG4gICAgcmV0dXJuIGZpbGVFeGlzdHM7XG4gIH1cblxuICBwcml2YXRlIGFzeW5jIHJlYWRIVE1MRmlsZShmaWxlUGF0aDogc3RyaW5nKTogUHJvbWlzZTxzdHJpbmcgfCB1bmRlZmluZWQ+IHtcbiAgICBpZiAodGhpcy5odG1sRmlsZUNhY2hlLmhhcyhmaWxlUGF0aCkpIHtcbiAgICAgIHJldHVybiB0aGlzLmh0bWxGaWxlQ2FjaGUuZ2V0KGZpbGVQYXRoKTtcbiAgICB9XG5cbiAgICBpZiAoYXdhaXQgdGhpcy5maWxlRXhpc3RzKGZpbGVQYXRoKSkge1xuICAgICAgY29uc3QgY29udGVudCA9IGF3YWl0IGZzLnByb21pc2VzLnJlYWRGaWxlKGZpbGVQYXRoLCAndXRmLTgnKTtcbiAgICAgIHRoaXMuaHRtbEZpbGVDYWNoZS5zZXQoZmlsZVBhdGgsIGNvbnRlbnQpO1xuXG4gICAgICByZXR1cm4gY29udGVudDtcbiAgICB9XG5cbiAgICByZXR1cm4gdW5kZWZpbmVkO1xuICB9XG59XG4iXX0=